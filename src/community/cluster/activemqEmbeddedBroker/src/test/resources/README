Remember to append the 'release' profile to the mvn compile command
then copy the datadir:
cp ${PROJECT}/src/web/app/src/main/webapp/data/ ${PROJECT}/src/web/app/src/main/webapp/data2/

To perform tests using Jetty (similar things for Tomcat) Use the Start class in src/test/java/ setting two different run with the following arguments:
 
Run 1 arguments:
-Djetty.port=8081
-Xmx512M
-DGEOSERVER_DATA_DIR=${PROJECT}/src/web/app/src/main/webapp/data/
-DGEOWEBCACHE_CACHE_DIR=/tmp/gwc1
-DCLUSTER_CONFIG_DIR=/tmp/cache1
-Dactivemq.base=/tmp/cache1/
-DGWC_DISKQUOTA_DISABLED=true
-DGWC_METASTORE_DISABLED=true
-Dactivemq.broker.transportConnectors.uri=peer://geoserver/broker1?jms.useAsyncSend=true,trace=true
-Dactivemq.jmx.host=localhost
-Dactivemq.jmx.port=1077
-Djava.security.policy=security.policy
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false

Run 2 arguments:
-Djetty.port=8082
-Xmx512M
-DGEOSERVER_DATA_DIR=${PROJECT}/src/web/app/src/main/webapp/data2/
-DGEOWEBCACHE_CACHE_DIR=/tmp/gwc2
-DCLUSTER_CONFIG_DIR=/tmp/cache2
-Dactivemq.base=/tmp/cache2
-DGWC_DISKQUOTA_DISABLED=true
-DGWC_METASTORE_DISABLED=true
-Dactivemq.broker.transportConnectors.uri=peer://geoserver/broker2?jms.useAsyncSend=true,trace=true
-Dactivemq.jmx.host=localhost
-Dactivemq.jmx.port=1098
-Djava.security.policy=security.policy
-Dcom.sun.management.jmxremote=true
-Dcom.sun.management.jmxremote.authenticate=false
-Dcom.sun.management.jmxremote.ssl=false

NOTE:
- jetty.port is specific for jetty and can be set also in jetty.property (environment will override it)
- activemq.jmx.port is specific of the defined activemq configuration and can be set into activemq-jmx.properties (environment will override it)

8081 cluster.properties:
-------------------------
toggleSlave=true
topicName=VirtualTopic.>
connection=enabled
brokerURL=peer\://geoserver?broker.persist\=false
toggleMaster=true
CLUSTER_CONFIG_DIR=/tmp/cache1
connection.retry=3
instanceName=0a10b8a0-8081-test
readOnly=enabled
connection.maxwait=1000
-------------------------

8081 cluster.properties:
-------------------------
toggleSlave=true
topicName=VirtualTopic.>
connection=enabled
brokerURL=peer\://geoserver?broker.persist\=false
toggleMaster=true
CLUSTER_CONFIG_DIR=/tmp/cache2
connection.retry=3
instanceName=9e05506e-8082-test
readOnly=enabled
connection.maxwait=1000
-------------------------


activemq-jmx.properties
-------------------------
# JMX settings (can be overridden by env vars
activemq.jmx.port=1098
activemq.jmx.host=localhost
activemq.usejmx=true
activemq.startembeddedbroker=true
# broker settings (OVERRIDDEN BY JVM ARGUMENTS)
activemq.broker.transportConnectors.uri=peer://geoserver/broker1?jms.useAsyncSend=true,trace=true,broker.persistent=true,broker.dataDirectory=./,broker.tmpDataDirectory=./
# persistence
activemq.base=./
activemq.broker.systemUsage.memoryUsage=200 mb
activemq.broker.systemUsage.storeUsage=1 gb
activemq.broker.systemUsage.tempUsage=200 mb

-------------------------
